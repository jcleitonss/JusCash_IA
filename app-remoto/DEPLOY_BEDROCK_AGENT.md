# ü§ñ Deploy JUSCRASH com Bedrock Agent

## üéØ Arquitetura

```
Frontend (S3 + CloudFront)
    ‚Üì
API Gateway
    ‚Üì
Lambda (LangGraph)
    ‚Üì
Bedrock Agent Runtime
    ‚Üì
Bedrock Agent (Claude 3.5 Sonnet)
```

---

## üìã Pr√©-requisitos

1. **AWS CLI configurado**
2. **Docker rodando**
3. **Credenciais em `keys/.env`**

---

## üöÄ Deploy Completo

### **Passo 1: Verificar credenciais**

```bash
cat keys/.env
```

Deve conter:
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_REGION`

---

### **Passo 2: Deploy Infraestrutura (Terraform)**

```bash
cd app-remoto/infrastructure

# Inicializar Terraform
docker compose -f docker-compose.deploy.yml run terraform-init

# Ver o que ser√° criado
docker compose -f docker-compose.deploy.yml run terraform-plan

# Criar recursos AWS
docker compose -f docker-compose.deploy.yml run terraform-apply
```

**Recursos criados:**
- ‚úÖ Bedrock Agent
- ‚úÖ Agent Alias (production)
- ‚úÖ Lambda Function
- ‚úÖ ECR Repository
- ‚úÖ API Gateway
- ‚úÖ S3 Buckets
- ‚úÖ CloudFront
- ‚úÖ IAM Roles

---

### **Passo 3: Pegar IDs do Bedrock Agent**

```bash
cd app-remoto/infrastructure

# Ver outputs
docker compose -f docker-compose.deploy.yml run terraform-output

# Copiar:
# - bedrock_agent_id
# - bedrock_agent_alias_id
```

---

### **Passo 4: Configurar vari√°veis de ambiente**

Adicione no `keys/.env`:

```bash
BEDROCK_AGENT_ID=XXXXXXXXXX
BEDROCK_AGENT_ALIAS_ID=XXXXXXXXXX
```

---

### **Passo 5: Deploy Backend (Lambda)**

```bash
cd app-remoto/infrastructure

# Build + Push Docker + Update Lambda
docker compose -f docker-compose.deploy.yml run deploy-backend
```

---

### **Passo 6: Deploy Frontend**

```bash
cd app-remoto/infrastructure

# Build React + Upload S3
docker compose -f docker-compose.deploy.yml run deploy-frontend
```

---

## ‚úÖ Testar

### **1. Health Check**

```bash
curl https://SEU_API_URL/health
```

Resposta esperada:
```json
{
  "status": "ok",
  "service": "juscrash-agent-core",
  "runtime": "aws-lambda",
  "bedrock_agent": {
    "agent_id": "XXXXXXXXXX",
    "agent_alias_id": "XXXXXXXXXX",
    "region": "us-east-1",
    "configured": true
  }
}
```

---

### **2. Verificar Processo**

```bash
curl -X POST https://SEU_API_URL/api/v1/verificar \
  -H "Content-Type: application/json" \
  -d '{
    "numeroProcesso": "0001234-56.2023.4.05.8100",
    "classe": "Cumprimento de Senten√ßa",
    "orgaoJulgador": "19¬™ VARA FEDERAL",
    "ultimaDistribuicao": "2023-01-01T00:00:00",
    "assunto": "Indeniza√ß√£o",
    "segredoJustica": false,
    "justicaGratuita": false,
    "siglaTribunal": "TRF5",
    "esfera": "Federal",
    "documentos": [],
    "movimentos": []
  }'
```

---

## üîÑ Atualizar

### **Atualizar c√≥digo do Lambda:**

```bash
cd app-remoto/infrastructure
docker compose -f docker-compose.deploy.yml run deploy-backend
```

### **Atualizar frontend:**

```bash
cd app-remoto/infrastructure
docker compose -f docker-compose.deploy.yml run deploy-frontend
```

---

## üêõ Troubleshooting

### **Erro: BEDROCK_AGENT_ID n√£o configurado**

Adicione no `keys/.env`:
```bash
BEDROCK_AGENT_ID=XXXXXXXXXX
BEDROCK_AGENT_ALIAS_ID=XXXXXXXXXX
```

### **Erro: Permission denied (Bedrock Agent)**

Verifique IAM role do Lambda:
```bash
aws iam get-role-policy \
  --role-name juscrash-lambda-role \
  --policy-name juscrash-lambda-policy
```

Deve ter permiss√µes:
- `bedrock:InvokeAgent`
- `bedrock:GetAgent`

### **Ver logs do Lambda:**

```bash
aws logs tail /aws/lambda/juscrash-agent-core --follow
```

---

## üí∞ Custos Estimados

| Servi√ßo | Custo Mensal |
|---------|--------------|
| Bedrock Agent | $0 (pay-per-use) |
| Bedrock Claude 3.5 | $15/1M tokens |
| Lambda | $10/10k requests |
| API Gateway | $0.35/10k requests |
| S3 + CloudFront | $5 |
| **Total** | **~$30/m√™s** |

---

## üìö Documenta√ß√£o

- **Bedrock Agents:** https://docs.aws.amazon.com/bedrock/latest/userguide/agents.html
- **LangGraph:** https://langchain-ai.github.io/langgraph/
- **Terraform AWS:** https://registry.terraform.io/providers/hashicorp/aws/

---

## ‚ú® Pr√≥ximos Passos

- [ ] Adicionar Knowledge Base (RAG)
- [ ] Configurar Guardrails
- [ ] Adicionar Code Interpreter
- [ ] Implementar mem√≥ria de sess√£o
- [ ] Custom domain (Route 53)
